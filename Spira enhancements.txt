// ==UserScript==
// @name       Spira enhancements
// @namespace  http://spira/
// @version    3.2
// @description  enter something useful
// @match      http*://thefactory.crossknowledge.com/*
// @match 	   http*://thefactory.crossknowledge.com/Popups/FileArtifactUploadDialog.aspx*
// @exclude    http://thefactory.crossknowledge.com/*/Incident/List.aspx*
// @copyright  2015+, You
// @require http://code.jquery.com/jquery-latest.js
// ==/UserScript==

$(".rteDiv").css("resize", "both");
$(".rteDiv").parent().parent().css("height", "auto");

if ($('#cplMainContent_radUrl'))
{
  unsafeWindow.myClickEvent = document.createEvent('MouseEvents');
  unsafeWindow.myClickEvent.initEvent('click', true, true);

  if (document.getElementById('cplMainContent_ddlDocType') && document.getElementById('cplMainContent_ddlDocFolder'))
  {
	// populate the lists
	function populate()
	{
	  document.getElementById('cplMainContent_ddlDocType').dispatchEvent(myClickEvent);
	  document.getElementById('cplMainContent_ddlDocFolder').dispatchEvent(myClickEvent);

	  jQuery('#cplMainContent_ddlDocType_list div:contains(Ticket)').attr('id', 'titicket');
	  jQuery('#cplMainContent_ddlDocFolder div[title=Internal]').attr('id', 'tintinternal');
	  jQuery('#cplMainContent_ddlDocType_list div:contains(URL)').attr('id', 'uhurl');

	  document.getElementById('tintinternal').dispatchEvent(myClickEvent);
	}

	setTimeout(populate, 500);
  }

  // Add onclick event on radio button for Keyze
  var onclick = "if ($find('tblAttachment')) $find('tblAttachment').show_attachment_type_url(); document.getElementById('cplMainContent_txtURL').value='https://crossknowledge.force.com/Community/';";
  onclick += "document.getElementById('titicket').dispatchEvent(myClickEvent);";

  $('#cplMainContent_radUrl').parent().append($('<input type="radio" name="AttachmentType" value="ctl00$cplMainContent$radUrl" onclick="' + onclick + '" />'));
  $('#cplMainContent_radUrl').parent().append('Keyze');

  $('#cplMainContent_radUrl').parents('table').css('width', '700px');
  $('#cplMainContent_txtURL, #cplMainContent_filAttachment, #cplMainContent_txtAttachmentDescription').css('width', '500px');

  $('#cplMainContent_tstAttachmentPanel_dlgUploadAttachment').css('width', '700px');
  $('#cplMainContent_tstAttachmentPanel_dlgUploadAttachment .DialogClose').css('left', '650px');

  // Change onclick event for URL radio button
  var onclick = "if ($find('tblAttachment')) $find('tblAttachment').show_attachment_type_url(); document.getElementById('cplMainContent_txtURL').value='';";
  onclick += "document.getElementById('uhurl').dispatchEvent(myClickEvent);";
  jQuery('#cplMainContent_radUrl').attr('onclick', onclick);
}

// Add "pre-fill" button on incident's description field
if (jQuery('#cplMainContent_pnlOverview_Description'))
{
  var tdButton = document.createElement("td");
  var button = document.createElement("button");
  button.innerHTML = 'Pre-fill for opening';
  button.className = 'prefill';
  tdButton.appendChild(button);
  button.setAttribute(
	"onclick",
	"var templateCommentaire = '<ul><li> <b>Incident :</b> <i> Mandatory details...</i> </li><li> <b>Context :</b> <i> Mandatory details (Phase, release etc...)</i> </li><li> <b>Revision/build :</b> <i> Mandatory</i> </li><li> <b>URL :</b> <i> Mandatory</i> </li><li> <b>Scenario (Screen Capture) :</b> <i> Attachement link mandatory </i></li><li> <b>Scenario (Video Capture) :</b> <i> Attachement link optional</i></li><li> <b>Comments :</b> <i>Details mandatory...</i></li></ul>'; document.querySelector('#cplMainContent_pnlOverview_Description .rteDiv').innerHTML = templateCommentaire;return false;");
  jQuery("#cplMainContent_pnlOverview_Description .rteBack tr").append(tdButton);
}

// Add "pre-fill" button on incident's comment field
if (jQuery('#cplMainContent_pnlOverview_Comments'))
{
  var tdButton = document.createElement("td");
  var button = document.createElement("button");
  button.innerHTML = 'Pre-fill for closure OK';
  button.className = 'prefill';
  tdButton.appendChild(button);
  button.setAttribute(
	"onclick",
	"var templateCommentaire = '<ul><li><span style=\"background-color: rgb(102, 255, 153);\"><b>Status :</b> <i> Mandatory</i> </li><li><span style=\"background-color: rgb(102, 255, 153);\"><b>Revision or Build :</b> <i> Mandatory</i></span></li><li><span style=\"background-color: rgb(102, 255, 153);\"><b>Context :</b> <i> Mandatory (Phase, Environment, Browser...)</i></span></li><li><span style=\"background-color: rgb(102, 255, 153);\"><b>URL :</b> <i> Mandatory</i></span></li><li><span style=\"background-color: rgb(102, 255, 153);\"><b>Scenario (Screen Capture) :</b> <i> Attachement link optional </i></span></li><li><span style=\"background-color: rgb(102, 255, 153);\"><b>Scenario (Video Capture) :</b> <i> Attachement link optional</i></span></li><li><span style=\"background-color: rgb(102, 255, 153);\"><b>Comments :</b> <i>Details mandatory...</i></span></li></ul>'; document.querySelector('#cplMainContent_pnlOverview_Comments .rteDiv').innerHTML = templateCommentaire;return false;");
  jQuery("#cplMainContent_pnlOverview_Comments .rteBack tr").append(tdButton);

  var tdButton = document.createElement("td");
  var button = document.createElement("button");
  button.innerHTML = 'Pre-fill for closure KO';
  button.className = 'prefill';
  tdButton.appendChild(button);
  button.setAttribute(
	"onclick",
	"var templateCommentaire = '<ul><li><span style=\"background-color: #FE2E2E;\"><b>Status :</b> <i> Mandatory</i> </li><li><span style=\"background-color: #FE2E2E;\"><b>Revision or Build :</b> <i> Mandatory</i></span></li><li><span style=\"background-color: #FE2E2E;\"><b>Context :</b> <i> Mandatory (Phase, Environment, Browser...)</i></span></li><li><span style=\"background-color: #FE2E2E;\"><b>URL :</b> <i> Mandatory</i></span></li><li><span style=\"background-color:#FE2E2E;\"><b>Scenario (Screen Capture) :</b> <i> Attachement link optional </i></span></li><li><span style=\"background-color: #FE2E2E;\"><b>Scenario (Video Capture) :</b> <i> Attachement link optional</i></span></li><li><span style=\"background-color: #FE2E2E;\"><b>Comments :</b> <i>Details mandatory...</i></span></li></ul>'; document.querySelector('#cplMainContent_pnlOverview_Comments .rteDiv').innerHTML = templateCommentaire;return false;");
  jQuery("#cplMainContent_pnlOverview_Comments .rteBack tr").append(tdButton);

  var tdButton = document.createElement("td");
  var button = document.createElement("button");
  button.innerHTML = 'Pre-fill for opening';
  button.className = 'prefill';
  tdButton.appendChild(button);
  button.setAttribute(
	"onclick",
	"var templateCommentaire = '<ul><li> <b>Incident :</b> <i> Mandatory details...</i> </li><li> <b>Context :</b> <i> Mandatory details (Phase, release etc...)</i> </li><li> <b>Revision/build :</b> <i> Mandatory</i> </li><li> <b>URL :</b> <i> Mandatory</i> </li><li> <b>Scenario (Screen Capture) :</b> <i> Attachement link mandatory </i></li><li> <b>Scenario (Video Capture) :</b> <i> Attachement link optional</i></li><li> <b>Comments :</b> <i>Details mandatory...</i></li></ul>'; document.querySelector('#cplMainContent_pnlOverview_Comments .rteDiv').innerHTML = templateCommentaire;return false;");
  jQuery("#cplMainContent_pnlOverview_Comments .rteBack tr").append(tdButton);

  var tdButton = document.createElement("td");
  var button = document.createElement("button");
  button.innerHTML = 'Pre-fill for correction';
  button.className = 'prefill';
  tdButton.appendChild(button);
  button.setAttribute(
	"onclick",
	"var templateCommentaire = '<ul><li> <b>Fixed</b> </li><li> <b>Problem * :</b> mandatory</li><li> <b>Solution * :</b> mandatory</li><li> <b>Tests * :</b> mandatory</li><li> <b>Possible impacts:</b> </li><li> <b>@QA (Non Reg.) :</b> </li><li> <b>@Support :</b> </li><li> <b>Origine :</b> </li></ul>';    document.querySelector('#cplMainContent_pnlOverview_Comments .rteDiv').innerHTML = templateCommentaire;return false;");
  jQuery("#cplMainContent_pnlOverview_Comments .rteBack tr").append(tdButton);

  var maxHeight = Math.max.apply(null, jQuery("#cplMainContent_pnlOverview_Comments .prefill").map(function() {
	return $(this).height();
  }).get());

  jQuery("#cplMainContent_pnlOverview_Comments .prefill").height(maxHeight);
  jQuery("#cplMainContent_pnlOverview_Comments .prefill").width(55);
}

// Add buttons to prefill the selected user in drop-down lists
function buttonOnCLick(dropDownId, searchItem)
{
  var dropDown = $find(dropDownId);
  var items = dropDown.get_items();

  for (i = 0; i < items.length; i++)
  {
	if(searchItem == items[i].get_text())
	{
	  dropDown.set_selectedItem(items[i]);
	}
  }
  return false;
}

function createButton(dropDownId)
{
  var referenceNode = document.querySelector("#" + dropDownId);

  if (!referenceNode || referenceNode.length === 0)
	return;

  // Create QA Team and a PHP Team button
  if (dropDownId == 'cplMainContent_ddlOwner')
  {
	var qaButton = document.createElement("button");
	qaButton.innerHTML = "QA Team";
	referenceNode.parentNode.insertBefore(qaButton, referenceNode.nextSibling);

	qaButton.onclick = function() {
	  return buttonOnCLick(dropDownId, "QA Team");
	};

	var teamButton = document.createElement("button");
	var teamButtonLabel = "";
	if(document.URL.match(/http(s)?:\/\/thefactory.crossknowledge\.com\/10\/*/))
	{
	  teamButtonLabel = "NET Team";
	}
	else{
	  teamButtonLabel = "PHP Team";
	}
	teamButton.innerHTML = teamButtonLabel;
	referenceNode.parentNode.insertBefore(teamButton, referenceNode.nextSibling);

	teamButton.onclick = function() {
	  return buttonOnCLick(dropDownId, teamButtonLabel);
	};
  }

  // Create Me button
  var meButton = document.createElement("button");
  meButton.innerHTML = "ME";
  referenceNode.parentNode.insertBefore(meButton, referenceNode.nextSibling);

  meButton.onclick = function() {
	var myName = document.querySelector("#tstGlobalNavigation_mnuUserOptions span").innerHTML;
	return buttonOnCLick(dropDownId, myName);
  };
}

createButton('cplMainContent_ddlOwner');
createButton('cplMainContent_ddlOpener');
createButton('cplMainContent_tblFields_Custom_05');
createButton('cplMainContent_tblFields_Custom_01');
createButton('cplMainContent_tblFields_Custom_02');

// improve the dimensions of some popups
jQuery('head').append('<style type="text/css">#cplMainContent_tstArtifactLinkPanel_ajxIncidentsSelector .Body, #cplMainContent_tstArtifactLinkPanel_ajxRequirementsSelector .Body { height: 500px !important; width: 420px !important; }' +
					  '#cplMainContent_tstArtifactLinkPanel_ajxIncidentsSelector .Header, #cplMainContent_tstArtifactLinkPanel_ajxRequirementsSelector .Header { height: 30px !important; width: 420px !important; }' +
					  '#cplMainContent_tstArtifactLinkPanel_ajxIncidentsSelector, #cplMainContent_tstArtifactLinkPanel_ajxRequirementsSelector { /* height: 150px;*/ height: 530px !important; width: 400px !important; }' +
					  '#cplMainContent_tstArtifactLinkPanel_pnlAddAssociation { height: 800px !important; left: 150px !important; top: 10px !important; width: 800px !important; }' +
					  '#cplMainContent_tstArtifactLinkPanel_pnlAddAssociation .DialogClose { left: 750px !important; }' +
					  '#cplMainContent_tstArtifactLinkPanel_txtComment { /*display: none !important;*/ }' +
					  '</style>');

